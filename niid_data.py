import numpy as np
np.random.seed(42)
import torch
from torchvision import datasets
import torchvision.transforms as transforms
import matplotlib.pyplot as plt
def dirichlet_split_noniid(train_labels, alpha, n_clients):
    '''
    参数为alpha的Dirichlet分布将数据索引划分为n_clients个子集
    '''
    n_classes = train_labels.max()+1
    label_distribution = np.random.dirichlet([alpha]*n_clients, n_classes)
    # (K, N)的类别标签分布矩阵X，记录每个client占有每个类别的多少

    class_idcs = [np.argwhere(train_labels==y).flatten()
           for y in range(n_classes)]
    # 记录每个K个类别对应的样本下标
    # print(class_idcs)
    client_idcs = [[] for _ in range(n_clients)]
    # 记录N个client分别对应样本集合的索引
    for c, fracs in zip(class_idcs, label_distribution):
        # np.split按照比例将类别为k的样本划分为了N个子集
        # for i, idcs 为遍历第i个client对应样本集合的索引
        for i, idcs in enumerate(np.split(c, (np.cumsum(fracs)[:-1]*len(c)).astype(int))):
            client_idcs[i] += [idcs]

    client_idcs = [np.concatenate(idcs) for idcs in client_idcs]

    return client_idcs



torch.manual_seed(42)

def get_niid_data(data_dir, n_clients, DIRICHLET_ALPHA):
    normalize = transforms.Normalize(mean=[0.485, 0.456, 0.406],
                                     std=[0.229, 0.224, 0.225])

    # the smaller alpha is, the more imbalance the dataset is

    # N_CLIENTS = 10
    # DIRICHLET_ALPHA = 0.5

    # train_data = datasets.EMNIST(root=".", split="byclass", download=True, train=True)
    test_data = datasets.ImageFolder(root=data_dir, transform=transforms.Compose([
        transforms.Resize(224),
        transforms.CenterCrop(224),
        transforms.ToTensor(),
        normalize,
    ]))

    test_labels = np.array(test_data.targets)

    # 我们让每个client不同label的样本数量不同，以此做到Non-IID划分
    client_idcs = dirichlet_split_noniid(test_labels, alpha=DIRICHLET_ALPHA, n_clients=n_clients)
    # [test_labels[idc] for idc in client_idcs]
    plt.figure(figsize=(20, 3))
    plt.hist(test_labels[client_idcs[0]], stacked=True,
             bins=np.arange(min(test_labels) - 0.5, max(test_labels) + 1.5, 1),
             label=["Client {}".format(i) for i in range(n_clients)], rwidth=0.5)
    plt.xticks(np.arange(1000), test_data.classes)
    plt.legend()
    plt.show()

    return client_idcs

def getdirichletprobs(alpha=0.01):
    gfg = np.random.dirichlet([alpha for i in range(100)], size=1000)
    summation = 0
    for i in range(gfg.shape[0]):
        summation += gfg[i][0]
    probs = []
    for i in range(gfg.shape[0]):
        probs.append(gfg[i][0] / summation)
    # probs.sort()
    # probs.reverse()
    # plt.bar([i for i in range(50)], probs[:50])  # gfg.shape[0]
    # plt.show()
    return probs

def getdataidxs(rawprobs, train=False, datanum=5000):
    if train:
        cls_start_idxs = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180, 190, 200, 210, 220, 230, 240, 250, 260, 270, 280, 290, 300, 310, 320, 330, 340, 350, 360, 370, 380, 390, 400, 410, 420, 430, 440, 450, 460, 470, 480, 490, 500, 510, 520, 530, 540, 550, 560, 570, 580, 590, 600, 610, 620, 630, 640, 650, 660, 670, 680, 690, 700, 710, 720, 730, 740, 750, 760, 770, 780, 790, 800, 810, 820, 830, 840, 850, 860, 870, 880, 890, 900, 910, 920, 930, 940, 950, 960, 970, 980, 990, 1000, 1010, 1020, 1030, 1040, 1050, 1060, 1070, 1080, 1090, 1100, 1110, 1120, 1130, 1140, 1150, 1160, 1170, 1180, 1190, 1200, 1210, 1220, 1230, 1240, 1250, 1260, 1270, 1280, 1290, 1300, 1310, 1320, 1330, 1340, 1350, 1360, 1370, 1380, 1390, 1400, 1410, 1420, 1430, 1440, 1450, 1460, 1470, 1480, 1490, 1500, 1510, 1520, 1530, 1540, 1550, 1560, 1570, 1580, 1590, 1600, 1610, 1620, 1630, 1640, 1650, 1660, 1670, 1680, 1690, 1700, 1710, 1720, 1730, 1740, 1750, 1760, 1770, 1780, 1790, 1800, 1810, 1820, 1830, 1840, 1850, 1860, 1870, 1880, 1890, 1900, 1910, 1920, 1930, 1940, 1950, 1960, 1970, 1980, 1990, 2000, 2010, 2020, 2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100, 2110, 2120, 2130, 2140, 2150, 2160, 2170, 2180, 2190, 2200, 2210, 2220, 2230, 2240, 2250, 2260, 2270, 2280, 2290, 2300, 2310, 2320, 2330, 2340, 2350, 2360, 2370, 2380, 2390, 2400, 2410, 2420, 2430, 2440, 2450, 2460, 2470, 2480, 2490, 2500, 2510, 2520, 2530, 2540, 2550, 2560, 2570, 2580, 2590, 2600, 2610, 2620, 2630, 2640, 2650, 2660, 2670, 2680, 2690, 2700, 2710, 2720, 2730, 2740, 2750, 2760, 2770, 2780, 2790, 2800, 2810, 2820, 2830, 2840, 2850, 2860, 2870, 2880, 2890, 2900, 2910, 2920, 2930, 2940, 2950, 2960, 2970, 2980, 2990, 3000, 3010, 3020, 3030, 3040, 3050, 3060, 3070, 3080, 3090, 3100, 3110, 3120, 3130, 3140, 3150, 3160, 3170, 3180, 3190, 3200, 3210, 3220, 3230, 3240, 3250, 3260, 3270, 3280, 3290, 3300, 3310, 3320, 3330, 3340, 3350, 3360, 3370, 3380, 3390, 3400, 3410, 3420, 3430, 3440, 3450, 3460, 3470, 3480, 3490, 3500, 3510, 3520, 3530, 3540, 3550, 3560, 3570, 3580, 3590, 3600, 3610, 3620, 3630, 3640, 3650, 3660, 3670, 3680, 3690, 3700, 3710, 3720, 3730, 3740, 3750, 3760, 3770, 3780, 3790, 3800, 3810, 3820, 3830, 3840, 3850, 3860, 3870, 3880, 3890, 3900, 3910, 3920, 3930, 3940, 3950, 3960, 3970, 3980, 3990, 4000, 4010, 4020, 4030, 4040, 4050, 4060, 4070, 4080, 4090, 4100, 4110, 4120, 4130, 4140, 4150, 4160, 4170, 4180, 4190, 4200, 4210, 4220, 4230, 4240, 4250, 4260, 4270, 4280, 4290, 4300, 4310, 4320, 4330, 4340, 4350, 4360, 4370, 4380, 4390, 4400, 4410, 4420, 4430, 4440, 4450, 4460, 4470, 4480, 4490, 4500, 4510, 4520, 4530, 4540, 4550, 4560, 4570, 4580, 4590, 4600, 4610, 4620, 4630, 4640, 4650, 4660, 4670, 4680, 4690, 4700, 4710, 4720, 4730, 4740, 4750, 4760, 4770, 4780, 4790, 4800, 4810, 4820, 4830, 4840, 4850, 4860, 4870, 4880, 4890, 4900, 4910, 4920, 4930, 4940, 4950, 4960, 4970, 4980, 4990, 5000, 5010, 5020, 5030, 5040, 5050, 5060, 5070, 5080, 5090, 5100, 5110, 5120, 5130, 5140, 5150, 5160, 5170, 5180, 5190, 5200, 5210, 5220, 5230, 5240, 5250, 5260, 5270, 5280, 5290, 5300, 5310, 5320, 5330, 5340, 5350, 5360, 5370, 5380, 5390, 5400, 5410, 5420, 5430, 5440, 5450, 5460, 5470, 5480, 5490, 5500, 5510, 5520, 5530, 5540, 5550, 5560, 5570, 5580, 5590, 5600, 5610, 5620, 5630, 5640, 5650, 5660, 5670, 5680, 5690, 5700, 5710, 5720, 5730, 5740, 5750, 5760, 5770, 5780, 5790, 5800, 5810, 5820, 5830, 5840, 5850, 5860, 5870, 5880, 5890, 5900, 5910, 5920, 5930, 5940, 5950, 5960, 5970, 5980, 5990, 6000, 6010, 6020, 6030, 6040, 6050, 6060, 6070, 6080, 6090, 6100, 6110, 6120, 6130, 6140, 6150, 6160, 6170, 6180, 6190, 6200, 6210, 6220, 6230, 6240, 6250, 6260, 6270, 6280, 6290, 6300, 6310, 6320, 6330, 6340, 6350, 6360, 6370, 6380, 6390, 6400, 6410, 6420, 6430, 6440, 6450, 6460, 6470, 6480, 6490, 6500, 6510, 6520, 6530, 6540, 6550, 6560, 6570, 6580, 6590, 6600, 6610, 6620, 6630, 6640, 6650, 6660, 6670, 6680, 6690, 6700, 6710, 6720, 6730, 6740, 6750, 6760, 6770, 6780, 6790, 6800, 6810, 6820, 6830, 6840, 6850, 6860, 6870, 6880, 6890, 6900, 6910, 6920, 6930, 6940, 6950, 6960, 6970, 6980, 6990, 7000, 7010, 7020, 7030, 7040, 7050, 7060, 7070, 7080, 7090, 7100, 7110, 7120, 7130, 7140, 7150, 7160, 7170, 7180, 7190, 7200, 7210, 7220, 7230, 7240, 7250, 7260, 7270, 7280, 7290, 7300, 7310, 7320, 7330, 7340, 7350, 7360, 7370, 7380, 7390, 7400, 7410, 7420, 7430, 7440, 7450, 7460, 7470, 7480, 7490, 7500, 7510, 7520, 7530, 7540, 7550, 7560, 7570, 7580, 7590, 7600, 7610, 7620, 7630, 7640, 7650, 7660, 7670, 7680, 7690, 7700, 7710, 7720, 7730, 7740, 7750, 7760, 7770, 7780, 7790, 7800, 7810, 7820, 7830, 7840, 7850, 7860, 7870, 7880, 7890, 7900, 7910, 7920, 7930, 7940, 7950, 7960, 7970, 7980, 7990, 8000, 8010, 8020, 8030, 8040, 8050, 8060, 8070, 8080, 8090, 8100, 8110, 8120, 8130, 8140, 8150, 8160, 8170, 8180, 8190, 8200, 8210, 8220, 8230, 8240, 8250, 8260, 8270, 8280, 8290, 8300, 8310, 8320, 8330, 8340, 8350, 8360, 8370, 8380, 8390, 8400, 8410, 8420, 8430, 8440, 8450, 8460, 8470, 8480, 8490, 8500, 8510, 8520, 8530, 8540, 8550, 8560, 8570, 8580, 8590, 8600, 8610, 8620, 8630, 8640, 8650, 8660, 8670, 8680, 8690, 8700, 8710, 8720, 8730, 8740, 8750, 8760, 8770, 8780, 8790, 8800, 8810, 8820, 8830, 8840, 8850, 8860, 8870, 8880, 8890, 8900, 8910, 8920, 8930, 8940, 8950, 8960, 8970, 8980, 8990, 9000, 9010, 9020, 9030, 9040, 9050, 9060, 9070, 9080, 9090, 9100, 9110, 9120, 9130, 9140, 9150, 9160, 9170, 9180, 9190, 9200, 9210, 9220, 9230, 9240, 9250, 9260, 9270, 9280, 9290, 9300, 9310, 9320, 9330, 9340, 9350, 9360, 9370, 9380, 9390, 9400, 9410, 9420, 9430, 9440, 9450, 9460, 9470, 9480, 9490, 9500, 9510, 9520, 9530, 9540, 9550, 9560, 9570, 9580, 9590, 9600, 9610, 9620, 9630, 9640, 9650, 9660, 9670, 9680, 9690, 9700, 9710, 9720, 9730, 9740, 9750, 9760, 9770, 9780, 9790, 9800, 9810, 9820, 9830, 9840, 9850, 9860, 9870, 9880, 9890, 9900, 9910, 9920, 9930, 9940, 9950, 9960, 9970, 9980, 9990, 10000]
        # cls_start_idxs = [0, 1300, 2600, 3900, 5200, 6500, 7800, 9100, 10400, 11700, 13000, 14300, 15600, 16900, 18200, 19500, 20800, 22100, 23400, 24700, 26000, 27300, 28600, 29900, 31200, 32500, 33800, 35100, 36400, 37700, 39000, 40300, 41600, 42900, 44200, 45500, 46800, 48100, 49400, 50700, 52000, 53300, 54600, 55900, 57017, 58317, 59617, 60917, 62217, 63517, 64817, 66117, 67383, 68683, 69983, 71283, 72583, 73883, 75183, 76483, 77783, 79083, 80383, 81454, 82754, 84054, 85354, 86654, 87954, 89254, 90554, 91854, 93154, 94454, 95754, 97054, 98354, 99654, 100954, 102254, 103554, 104854, 106154, 107454, 108754, 110054, 111354, 112654, 113954, 115254, 116554, 117854, 119154, 120454, 121754, 123054, 124354, 125654, 126954, 128095, 129395, 130695, 131995, 133295, 134567, 135867, 137167, 138467, 139767, 141067, 142367, 143667, 144967, 146267, 147567, 148867, 150167, 151467, 152767, 154067, 155367, 156667, 157967, 159267, 160567, 161867, 163167, 164467, 165767, 167067, 168367, 169667, 170967, 172267, 173567, 174867, 176167, 177467, 178767, 180067, 181367, 182667, 183967, 185267, 186567, 187867, 189167, 190467, 191617, 192917, 194217, 195517, 196817, 197589, 198889, 200189, 201489, 202789, 204089, 204949, 206249, 207549, 208849, 210149, 211449, 212585, 213317, 214342, 215096, 216386, 217686, 218986, 220286, 221586, 222886, 224186, 224924, 226224, 227524, 228824, 230124, 231424, 232682, 233982, 235255, 236555, 237855, 239155, 240455, 241432, 242732, 243668, 244968, 246268, 247568, 248724, 250024, 251324, 252624, 253924, 255224, 256524, 257824, 259124, 260424, 261724, 263024, 264242, 265542, 266842, 268142, 269442, 270742, 272042, 273342, 274642, 275942, 277242, 278542, 279842, 281142, 282442, 283411, 284711, 286011, 287311, 288611, 289911, 291211, 292511, 293811, 295111, 296411, 297711, 299011, 300311, 301611, 302911, 304211, 305511, 306811, 308111, 309411, 310711, 312011, 313311, 314611, 315911, 317211, 318511, 319811, 321111, 322411, 323365, 324665, 325965, 327265, 328565, 329865, 331165, 332465, 333765, 335065, 336135, 337435, 338735, 340035, 341335, 342635, 343390, 344690, 345990, 347290, 348590, 349890, 351190, 352490, 353790, 355090, 356390, 357690, 358990, 360290, 361590, 362890, 364190, 365490, 366790, 368090, 369390, 370690, 371990, 373290, 374590, 375890, 377190, 378490, 379790, 381090, 382390, 383690, 384990, 386290, 387590, 388890, 390190, 391490, 392790, 394090, 395390, 396690, 397990, 399290, 400590, 401890, 403190, 404490, 405790, 407090, 408390, 409690, 410990, 412290, 413590, 414890, 416190, 417490, 418790, 420090, 421390, 422690, 423990, 425290, 426590, 427890, 429190, 430396, 431696, 432996, 434296, 435596, 436896, 438196, 439496, 440796, 442096, 443396, 444696, 445996, 447296, 448596, 449896, 451196, 452496, 453796, 455096, 456396, 457696, 458996, 460296, 461596, 462896, 464196, 465496, 466796, 468096, 469396, 470696, 471996, 473296, 474596, 475896, 477196, 478496, 479796, 481096, 482396, 483696, 484996, 486296, 487596, 488896, 490196, 491496, 492796, 494096, 495396, 496696, 497996, 499296, 500596, 501761, 503061, 504030, 505330, 506630, 507930, 509230, 510530, 511830, 513130, 514430, 515730, 517030, 518330, 519630, 520930, 522230, 523530, 524830, 526122, 527422, 528722, 530022, 531322, 532622, 533922, 535222, 536522, 537758, 539058, 540358, 541658, 542958, 544258, 545558, 546858, 548057, 549357, 550657, 551957, 553257, 554557, 555857, 557157, 558457, 559757, 561057, 562357, 563657, 564866, 566166, 567466, 568766, 570066, 571366, 572666, 573966, 575266, 576566, 577866, 579166, 580466, 581766, 583066, 584366, 585666, 586966, 588266, 589566, 590866, 592166, 593466, 594766, 596066, 597366, 598542, 599842, 601142, 602442, 603742, 605042, 606342, 607642, 608942, 610242, 611542, 612842, 614142, 615442, 616742, 618042, 619228, 620528, 621828, 623128, 624428, 625728, 627028, 628328, 629628, 630928, 632122, 633422, 634722, 636022, 637322, 638622, 639922, 641222, 642289, 643589, 644618, 645918, 647072, 648372, 649672, 650972, 652188, 653488, 654788, 656088, 657388, 658688, 659988, 661288, 662588, 663888, 665188, 666488, 667788, 669088, 670275, 671575, 672875, 674175, 675475, 676775, 678075, 679375, 680675, 681975, 682864, 684164, 685464, 686764, 688064, 689275, 690575, 691875, 693175, 694475, 695775, 697075, 698375, 699675, 700975, 702275, 703575, 704875, 706175, 707311, 708464, 709764, 711064, 712364, 713664, 714964, 716264, 717564, 718864, 720164, 721464, 722764, 724064, 725364, 726664, 727964, 729186, 730486, 731786, 733086, 734386, 735686, 736986, 738286, 739586, 740886, 742168, 743468, 744768, 746068, 747368, 748668, 749951, 751251, 752231, 753531, 754831, 756131, 757431, 758465, 759765, 761065, 762365, 763665, 764965, 765856, 767156, 768456, 769756, 771056, 772356, 773656, 774956, 776256, 777556, 778856, 780156, 781456, 782756, 784041, 785341, 786641, 787941, 789241, 790541, 791841, 793141, 794441, 795741, 797041, 798341, 799641, 800627, 801927, 803227, 804527, 805827, 807127, 808427, 809564, 810836, 812136, 813436, 814736, 815891, 817191, 818491, 819791, 821091, 822391, 823691, 824991, 826291, 827591, 828891, 830191, 831491, 832791, 834091, 835391, 836691, 837991, 839088, 840388, 841688, 842988, 844288, 845588, 846888, 848188, 849488, 850637, 851792, 853092, 854392, 855692, 856992, 858292, 859592, 860892, 862192, 863492, 864792, 866092, 867251, 868384, 869684, 870864, 872164, 873464, 874764, 876064, 877364, 878664, 879964, 881084, 882384, 883684, 884689, 885989, 887289, 888589, 889889, 891189, 892489, 893789, 895089, 896389, 897689, 898989, 900289, 901589, 902889, 904189, 905489, 906641, 907941, 909097, 910397, 911697, 912997, 913959, 915259, 916416, 917716, 919016, 920316, 921616, 922916, 924216, 925516, 926798, 927915, 929033, 930333, 931633, 932903, 933972, 935025, 936325, 937579, 938879, 940179, 941479, 942779, 944079, 945379, 946679, 947979, 948887, 950187, 951487, 952787, 954087, 955387, 956687, 957934, 959234, 960534, 961834, 963134, 964434, 965687, 966987, 968287, 969587, 970887, 972187, 973487, 974787, 976087, 977387, 978687, 979987, 981287, 982587, 983887, 985187, 986487, 987787, 988816, 990075, 991375, 992675, 993975, 995275, 996575, 997875, 999175, 1000475, 1001775, 1003042, 1004342, 1005642, 1006942, 1008242, 1009542, 1010842, 1012091, 1013391, 1014691, 1015991, 1017291, 1018591, 1019891, 1021191, 1022491, 1023653, 1024953, 1026253, 1027553, 1028853, 1030153, 1031453, 1032753, 1034053, 1035353, 1036653, 1037953, 1038998, 1040002, 1041240, 1042540, 1043840, 1045140, 1046440, 1047740, 1049040, 1050340, 1051640, 1052793, 1054093, 1055393, 1056693, 1057993, 1059077, 1060377, 1061677, 1062977, 1064277, 1065577, 1066877, 1068177, 1069477, 1070777, 1072077, 1073377, 1074594, 1075894, 1077194, 1078125, 1079425, 1080725, 1082025, 1083325, 1084625, 1085925, 1087225, 1088525, 1089825, 1091125, 1092425, 1093725, 1094989, 1096289, 1097589, 1098565, 1099865, 1101165, 1102415, 1103715, 1105015, 1106315, 1107615, 1108915, 1110215, 1111515, 1112815, 1113868, 1115168, 1116468, 1117628, 1118928, 1120228, 1121528, 1122828, 1124128, 1125428, 1126728, 1128028, 1129328, 1130628, 1131928, 1133228, 1134290, 1135590, 1136890, 1138190, 1139490, 1140790, 1141927, 1143226, 1144526, 1145826, 1147126, 1148426, 1149726, 1151026, 1152326, 1153626, 1154681, 1155981, 1157281, 1158581, 1159881, 1161094, 1162394, 1163694, 1164994, 1166294, 1167594, 1168894, 1170194, 1171400, 1172700, 1174000, 1175300, 1176600, 1177900, 1179200, 1180354, 1181654, 1182954, 1184254, 1185461, 1186610, 1187910, 1189210, 1190510, 1191810, 1193110, 1194410, 1195710, 1197010, 1198310, 1199610, 1200910, 1202210, 1203510, 1204749, 1206049, 1207349, 1208649, 1209949, 1211249, 1212374, 1213674, 1214974, 1216274, 1217574, 1218874, 1220174, 1221474, 1222774, 1224074, 1225374, 1226674, 1227974, 1229274, 1230574, 1231874, 1233174, 1234474, 1235774, 1237074, 1238374, 1239674, 1240974, 1242167, 1243467, 1244767, 1246067, 1247367, 1248667, 1249967, 1251267, 1252567, 1253867, 1255167, 1256467, 1257767, 1259067, 1260367, 1261667, 1262967, 1264267, 1265567, 1266867, 1268167, 1269467, 1270767, 1272067, 1273367, 1274667, 1275967, 1277267, 1278567, 1279867, 1281167]
    else:
        cls_start_idxs = [0, 40, 80, 120, 160, 200, 240, 280, 320, 360, 400, 440, 480, 520, 560, 600, 640, 680, 720, 760, 800, 840, 880, 920, 960, 1000, 1040, 1080, 1120, 1160, 1200, 1240, 1280, 1320, 1360, 1400, 1440, 1480, 1520, 1560, 1600, 1640, 1680, 1720, 1760, 1800, 1840, 1880, 1920, 1960, 2000, 2040, 2080, 2120, 2160, 2200, 2240, 2280, 2320, 2360, 2400, 2440, 2480, 2520, 2560, 2600, 2640, 2680, 2720, 2760, 2800, 2840, 2880, 2920, 2960, 3000, 3040, 3080, 3120, 3160, 3200, 3240, 3280, 3320, 3360, 3400, 3440, 3480, 3520, 3560, 3600, 3640, 3680, 3720, 3760, 3800, 3840, 3880, 3920, 3960, 4000, 4040, 4080, 4120, 4160, 4200, 4240, 4280, 4320, 4360, 4400, 4440, 4480, 4520, 4560, 4600, 4640, 4680, 4720, 4760, 4800, 4840, 4880, 4920, 4960, 5000, 5040, 5080, 5120, 5160, 5200, 5240, 5280, 5320, 5360, 5400, 5440, 5480, 5520, 5560, 5600, 5640, 5680, 5720, 5760, 5800, 5840, 5880, 5920, 5960, 6000, 6040, 6080, 6120, 6160, 6200, 6240, 6280, 6320, 6360, 6400, 6440, 6480, 6520, 6560, 6600, 6640, 6680, 6720, 6760, 6800, 6840, 6880, 6920, 6960, 7000, 7040, 7080, 7120, 7160, 7200, 7240, 7280, 7320, 7360, 7400, 7440, 7480, 7520, 7560, 7600, 7640, 7680, 7720, 7760, 7800, 7840, 7880, 7920, 7960, 8000, 8040, 8080, 8120, 8160, 8200, 8240, 8280, 8320, 8360, 8400, 8440, 8480, 8520, 8560, 8600, 8640, 8680, 8720, 8760, 8800, 8840, 8880, 8920, 8960, 9000, 9040, 9080, 9120, 9160, 9200, 9240, 9280, 9320, 9360, 9400, 9440, 9480, 9520, 9560, 9600, 9640, 9680, 9720, 9760, 9800, 9840, 9880, 9920, 9960, 10000, 10040, 10080, 10120, 10160, 10200, 10240, 10280, 10320, 10360, 10400, 10440, 10480, 10520, 10560, 10600, 10640, 10680, 10720, 10760, 10800, 10840, 10880, 10920, 10960, 11000, 11040, 11080, 11120, 11160, 11200, 11240, 11280, 11320, 11360, 11400, 11440, 11480, 11520, 11560, 11600, 11640, 11680, 11720, 11760, 11800, 11840, 11880, 11920, 11960, 12000, 12040, 12080, 12120, 12160, 12200, 12240, 12280, 12320, 12360, 12400, 12440, 12480, 12520, 12560, 12600, 12640, 12680, 12720, 12760, 12800, 12840, 12880, 12920, 12960, 13000, 13040, 13080, 13120, 13160, 13200, 13240, 13280, 13320, 13360, 13400, 13440, 13480, 13520, 13560, 13600, 13640, 13680, 13720, 13760, 13800, 13840, 13880, 13920, 13960, 14000, 14040, 14080, 14120, 14160, 14200, 14240, 14280, 14320, 14360, 14400, 14440, 14480, 14520, 14560, 14600, 14640, 14680, 14720, 14760, 14800, 14840, 14880, 14920, 14960, 15000, 15040, 15080, 15120, 15160, 15200, 15240, 15280, 15320, 15360, 15400, 15440, 15480, 15520, 15560, 15600, 15640, 15680, 15720, 15760, 15800, 15840, 15880, 15920, 15960, 16000, 16040, 16080, 16120, 16160, 16200, 16240, 16280, 16320, 16360, 16400, 16440, 16480, 16520, 16560, 16600, 16640, 16680, 16720, 16760, 16800, 16840, 16880, 16920, 16960, 17000, 17040, 17080, 17120, 17160, 17200, 17240, 17280, 17320, 17360, 17400, 17440, 17480, 17520, 17560, 17600, 17640, 17680, 17720, 17760, 17800, 17840, 17880, 17920, 17960, 18000, 18040, 18080, 18120, 18160, 18200, 18240, 18280, 18320, 18360, 18400, 18440, 18480, 18520, 18560, 18600, 18640, 18680, 18720, 18760, 18800, 18840, 18880, 18920, 18960, 19000, 19040, 19080, 19120, 19160, 19200, 19240, 19280, 19320, 19360, 19400, 19440, 19480, 19520, 19560, 19600, 19640, 19680, 19720, 19760, 19800, 19840, 19880, 19920, 19960, 20000, 20040, 20080, 20120, 20160, 20200, 20240, 20280, 20320, 20360, 20400, 20440, 20480, 20520, 20560, 20600, 20640, 20680, 20720, 20760, 20800, 20840, 20880, 20920, 20960, 21000, 21040, 21080, 21120, 21160, 21200, 21240, 21280, 21320, 21360, 21400, 21440, 21480, 21520, 21560, 21600, 21640, 21680, 21720, 21760, 21800, 21840, 21880, 21920, 21960, 22000, 22040, 22080, 22120, 22160, 22200, 22240, 22280, 22320, 22360, 22400, 22440, 22480, 22520, 22560, 22600, 22640, 22680, 22720, 22760, 22800, 22840, 22880, 22920, 22960, 23000, 23040, 23080, 23120, 23160, 23200, 23240, 23280, 23320, 23360, 23400, 23440, 23480, 23520, 23560, 23600, 23640, 23680, 23720, 23760, 23800, 23840, 23880, 23920, 23960, 24000, 24040, 24080, 24120, 24160, 24200, 24240, 24280, 24320, 24360, 24400, 24440, 24480, 24520, 24560, 24600, 24640, 24680, 24720, 24760, 24800, 24840, 24880, 24920, 24960, 25000, 25040, 25080, 25120, 25160, 25200, 25240, 25280, 25320, 25360, 25400, 25440, 25480, 25520, 25560, 25600, 25640, 25680, 25720, 25760, 25800, 25840, 25880, 25920, 25960, 26000, 26040, 26080, 26120, 26160, 26200, 26240, 26280, 26320, 26360, 26400, 26440, 26480, 26520, 26560, 26600, 26640, 26680, 26720, 26760, 26800, 26840, 26880, 26920, 26960, 27000, 27040, 27080, 27120, 27160, 27200, 27240, 27280, 27320, 27360, 27400, 27440, 27480, 27520, 27560, 27600, 27640, 27680, 27720, 27760, 27800, 27840, 27880, 27920, 27960, 28000, 28040, 28080, 28120, 28160, 28200, 28240, 28280, 28320, 28360, 28400, 28440, 28480, 28520, 28560, 28600, 28640, 28680, 28720, 28760, 28800, 28840, 28880, 28920, 28960, 29000, 29040, 29080, 29120, 29160, 29200, 29240, 29280, 29320, 29360, 29400, 29440, 29480, 29520, 29560, 29600, 29640, 29680, 29720, 29760, 29800, 29840, 29880, 29920, 29960, 30000, 30040, 30080, 30120, 30160, 30200, 30240, 30280, 30320, 30360, 30400, 30440, 30480, 30520, 30560, 30600, 30640, 30680, 30720, 30760, 30800, 30840, 30880, 30920, 30960, 31000, 31040, 31080, 31120, 31160, 31200, 31240, 31280, 31320, 31360, 31400, 31440, 31480, 31520, 31560, 31600, 31640, 31680, 31720, 31760, 31800, 31840, 31880, 31920, 31960, 32000, 32040, 32080, 32120, 32160, 32200, 32240, 32280, 32320, 32360, 32400, 32440, 32480, 32520, 32560, 32600, 32640, 32680, 32720, 32760, 32800, 32840, 32880, 32920, 32960, 33000, 33040, 33080, 33120, 33160, 33200, 33240, 33280, 33320, 33360, 33400, 33440, 33480, 33520, 33560, 33600, 33640, 33680, 33720, 33760, 33800, 33840, 33880, 33920, 33960, 34000, 34040, 34080, 34120, 34160, 34200, 34240, 34280, 34320, 34360, 34400, 34440, 34480, 34520, 34560, 34600, 34640, 34680, 34720, 34760, 34800, 34840, 34880, 34920, 34960, 35000, 35040, 35080, 35120, 35160, 35200, 35240, 35280, 35320, 35360, 35400, 35440, 35480, 35520, 35560, 35600, 35640, 35680, 35720, 35760, 35800, 35840, 35880, 35920, 35960, 36000, 36040, 36080, 36120, 36160, 36200, 36240, 36280, 36320, 36360, 36400, 36440, 36480, 36520, 36560, 36600, 36640, 36680, 36720, 36760, 36800, 36840, 36880, 36920, 36960, 37000, 37040, 37080, 37120, 37160, 37200, 37240, 37280, 37320, 37360, 37400, 37440, 37480, 37520, 37560, 37600, 37640, 37680, 37720, 37760, 37800, 37840, 37880, 37920, 37960, 38000, 38040, 38080, 38120, 38160, 38200, 38240, 38280, 38320, 38360, 38400, 38440, 38480, 38520, 38560, 38600, 38640, 38680, 38720, 38760, 38800, 38840, 38880, 38920, 38960, 39000, 39040, 39080, 39120, 39160, 39200, 39240, 39280, 39320, 39360, 39400, 39440, 39480, 39520, 39560, 39600, 39640, 39680, 39720, 39760, 39800, 39840, 39880, 39920, 39960, 40000]
        # cls_start_idxs = [0, 50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000, 1050, 1100, 1150, 1200, 1250, 1300, 1350, 1400, 1450, 1500, 1550, 1600, 1650, 1700, 1750, 1800, 1850, 1900, 1950, 2000, 2050, 2100, 2150, 2200, 2250, 2300, 2350, 2400, 2450, 2500, 2550, 2600, 2650, 2700, 2750, 2800, 2850, 2900, 2950, 3000, 3050, 3100, 3150, 3200, 3250, 3300, 3350, 3400, 3450, 3500, 3550, 3600, 3650, 3700, 3750, 3800, 3850, 3900, 3950, 4000, 4050, 4100, 4150, 4200, 4250, 4300, 4350, 4400, 4450, 4500, 4550, 4600, 4650, 4700, 4750, 4800, 4850, 4900, 4950, 5000, 5050, 5100, 5150, 5200, 5250, 5300, 5350, 5400, 5450, 5500, 5550, 5600, 5650, 5700, 5750, 5800, 5850, 5900, 5950, 6000, 6050, 6100, 6150, 6200, 6250, 6300, 6350, 6400, 6450, 6500, 6550, 6600, 6650, 6700, 6750, 6800, 6850, 6900, 6950, 7000, 7050, 7100, 7150, 7200, 7250, 7300, 7350, 7400, 7450, 7500, 7550, 7600, 7650, 7700, 7750, 7800, 7850, 7900, 7950, 8000, 8050, 8100, 8150, 8200, 8250, 8300, 8350, 8400, 8450, 8500, 8550, 8600, 8650, 8700, 8750, 8800, 8850, 8900, 8950, 9000, 9050, 9100, 9150, 9200, 9250, 9300, 9350, 9400, 9450, 9500, 9550, 9600, 9650, 9700, 9750, 9800, 9850, 9900, 9950, 10000, 10050, 10100, 10150, 10200, 10250, 10300, 10350, 10400, 10450, 10500, 10550, 10600, 10650, 10700, 10750, 10800, 10850, 10900, 10950, 11000, 11050, 11100, 11150, 11200, 11250, 11300, 11350, 11400, 11450, 11500, 11550, 11600, 11650, 11700, 11750, 11800, 11850, 11900, 11950, 12000, 12050, 12100, 12150, 12200, 12250, 12300, 12350, 12400, 12450, 12500, 12550, 12600, 12650, 12700, 12750, 12800, 12850, 12900, 12950, 13000, 13050, 13100, 13150, 13200, 13250, 13300, 13350, 13400, 13450, 13500, 13550, 13600, 13650, 13700, 13750, 13800, 13850, 13900, 13950, 14000, 14050, 14100, 14150, 14200, 14250, 14300, 14350, 14400, 14450, 14500, 14550, 14600, 14650, 14700, 14750, 14800, 14850, 14900, 14950, 15000, 15050, 15100, 15150, 15200, 15250, 15300, 15350, 15400, 15450, 15500, 15550, 15600, 15650, 15700, 15750, 15800, 15850, 15900, 15950, 16000, 16050, 16100, 16150, 16200, 16250, 16300, 16350, 16400, 16450, 16500, 16550, 16600, 16650, 16700, 16750, 16800, 16850, 16900, 16950, 17000, 17050, 17100, 17150, 17200, 17250, 17300, 17350, 17400, 17450, 17500, 17550, 17600, 17650, 17700, 17750, 17800, 17850, 17900, 17950, 18000, 18050, 18100, 18150, 18200, 18250, 18300, 18350, 18400, 18450, 18500, 18550, 18600, 18650, 18700, 18750, 18800, 18850, 18900, 18950, 19000, 19050, 19100, 19150, 19200, 19250, 19300, 19350, 19400, 19450, 19500, 19550, 19600, 19650, 19700, 19750, 19800, 19850, 19900, 19950, 20000, 20050, 20100, 20150, 20200, 20250, 20300, 20350, 20400, 20450, 20500, 20550, 20600, 20650, 20700, 20750, 20800, 20850, 20900, 20950, 21000, 21050, 21100, 21150, 21200, 21250, 21300, 21350, 21400, 21450, 21500, 21550, 21600, 21650, 21700, 21750, 21800, 21850, 21900, 21950, 22000, 22050, 22100, 22150, 22200, 22250, 22300, 22350, 22400, 22450, 22500, 22550, 22600, 22650, 22700, 22750, 22800, 22850, 22900, 22950, 23000, 23050, 23100, 23150, 23200, 23250, 23300, 23350, 23400, 23450, 23500, 23550, 23600, 23650, 23700, 23750, 23800, 23850, 23900, 23950, 24000, 24050, 24100, 24150, 24200, 24250, 24300, 24350, 24400, 24450, 24500, 24550, 24600, 24650, 24700, 24750, 24800, 24850, 24900, 24950, 25000, 25050, 25100, 25150, 25200, 25250, 25300, 25350, 25400, 25450, 25500, 25550, 25600, 25650, 25700, 25750, 25800, 25850, 25900, 25950, 26000, 26050, 26100, 26150, 26200, 26250, 26300, 26350, 26400, 26450, 26500, 26550, 26600, 26650, 26700, 26750, 26800, 26850, 26900, 26950, 27000, 27050, 27100, 27150, 27200, 27250, 27300, 27350, 27400, 27450, 27500, 27550, 27600, 27650, 27700, 27750, 27800, 27850, 27900, 27950, 28000, 28050, 28100, 28150, 28200, 28250, 28300, 28350, 28400, 28450, 28500, 28550, 28600, 28650, 28700, 28750, 28800, 28850, 28900, 28950, 29000, 29050, 29100, 29150, 29200, 29250, 29300, 29350, 29400, 29450, 29500, 29550, 29600, 29650, 29700, 29750, 29800, 29850, 29900, 29950, 30000, 30050, 30100, 30150, 30200, 30250, 30300, 30350, 30400, 30450, 30500, 30550, 30600, 30650, 30700, 30750, 30800, 30850, 30900, 30950, 31000, 31050, 31100, 31150, 31200, 31250, 31300, 31350, 31400, 31450, 31500, 31550, 31600, 31650, 31700, 31750, 31800, 31850, 31900, 31950, 32000, 32050, 32100, 32150, 32200, 32250, 32300, 32350, 32400, 32450, 32500, 32550, 32600, 32650, 32700, 32750, 32800, 32850, 32900, 32950, 33000, 33050, 33100, 33150, 33200, 33250, 33300, 33350, 33400, 33450, 33500, 33550, 33600, 33650, 33700, 33750, 33800, 33850, 33900, 33950, 34000, 34050, 34100, 34150, 34200, 34250, 34300, 34350, 34400, 34450, 34500, 34550, 34600, 34650, 34700, 34750, 34800, 34850, 34900, 34950, 35000, 35050, 35100, 35150, 35200, 35250, 35300, 35350, 35400, 35450, 35500, 35550, 35600, 35650, 35700, 35750, 35800, 35850, 35900, 35950, 36000, 36050, 36100, 36150, 36200, 36250, 36300, 36350, 36400, 36450, 36500, 36550, 36600, 36650, 36700, 36750, 36800, 36850, 36900, 36950, 37000, 37050, 37100, 37150, 37200, 37250, 37300, 37350, 37400, 37450, 37500, 37550, 37600, 37650, 37700, 37750, 37800, 37850, 37900, 37950, 38000, 38050, 38100, 38150, 38200, 38250, 38300, 38350, 38400, 38450, 38500, 38550, 38600, 38650, 38700, 38750, 38800, 38850, 38900, 38950, 39000, 39050, 39100, 39150, 39200, 39250, 39300, 39350, 39400, 39450, 39500, 39550, 39600, 39650, 39700, 39750, 39800, 39850, 39900, 39950, 40000, 40050, 40100, 40150, 40200, 40250, 40300, 40350, 40400, 40450, 40500, 40550, 40600, 40650, 40700, 40750, 40800, 40850, 40900, 40950, 41000, 41050, 41100, 41150, 41200, 41250, 41300, 41350, 41400, 41450, 41500, 41550, 41600, 41650, 41700, 41750, 41800, 41850, 41900, 41950, 42000, 42050, 42100, 42150, 42200, 42250, 42300, 42350, 42400, 42450, 42500, 42550, 42600, 42650, 42700, 42750, 42800, 42850, 42900, 42950, 43000, 43050, 43100, 43150, 43200, 43250, 43300, 43350, 43400, 43450, 43500, 43550, 43600, 43650, 43700, 43750, 43800, 43850, 43900, 43950, 44000, 44050, 44100, 44150, 44200, 44250, 44300, 44350, 44400, 44450, 44500, 44550, 44600, 44650, 44700, 44750, 44800, 44850, 44900, 44950, 45000, 45050, 45100, 45150, 45200, 45250, 45300, 45350, 45400, 45450, 45500, 45550, 45600, 45650, 45700, 45750, 45800, 45850, 45900, 45950, 46000, 46050, 46100, 46150, 46200, 46250, 46300, 46350, 46400, 46450, 46500, 46550, 46600, 46650, 46700, 46750, 46800, 46850, 46900, 46950, 47000, 47050, 47100, 47150, 47200, 47250, 47300, 47350, 47400, 47450, 47500, 47550, 47600, 47650, 47700, 47750, 47800, 47850, 47900, 47950, 48000, 48050, 48100, 48150, 48200, 48250, 48300, 48350, 48400, 48450, 48500, 48550, 48600, 48650, 48700, 48750, 48800, 48850, 48900, 48950, 49000, 49050, 49100, 49150, 49200, 49250, 49300, 49350, 49400, 49450, 49500, 49550, 49600, 49650, 49700, 49750, 49800, 49850, 49900, 49950, 50000]
    # datanum=5000
    probs = [int(prob*datanum) for prob in rawprobs]
    idxs = []
    for probidx in range(len(probs)):
        if probs[probidx]>0:
            idxs += np.random.choice([i for i in range(cls_start_idxs[probidx], cls_start_idxs[probidx+1])], probs[probidx]).tolist()
    print(len(idxs))
    return idxs
    # probs.sort()
    # probs.reverse()
    # plt.bar([i for i in range(100)], probs[:100])  # gfg.shape[0]
    # plt.show()
    # print(probs)

if __name__ == "__main__":
    getdataidxs(getdirichletprobs())
    # splits = get_niid_data("../../project1/MultiBranchNet/mobilenet-yolov4-pytorch/pytorch-image-models-master/data/imagenet/val", n_clients=10, DIRICHLET_ALPHA=10)
    # import pdb;pdb.set_trace()
    # for i in range(len(splits)):
    #     t = splits[i].tolist()
    #     import pdb;pdb.set_trace()
    # sm = 0
    # for i in range(len(splits)):
    #     sm += splits[i].shape[0]
    # print(sm)